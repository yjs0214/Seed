#include <SoftwareSerial.h>
#include <TinyGPS++.h>
#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <DHT.h>
#include <Servo.h>  // ì„œë³´ëª¨í„° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€

// Wi-Fi ì •ë³´
const char* ssid = "ë°°ì°Œë°°ë¥¼ë•Œì°Œ";
const char* password = "021402140214";

// GPS ì‹œë¦¬ì–¼ ì„¤ì • (D6 = RX, D7 = TX)
SoftwareSerial gpsSerial(D6, D7);
TinyGPSPlus gps;

// ì›¹ ì„œë²„ ìƒì„±
ESP8266WebServer server(80);

// DHT ì„¤ì •
#define DHTPIN 14    
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);


#define SERVO_PIN 2
Servo myServo;

String lastLocation = "";

// ì›¹í˜ì´ì§€ ì¶œë ¥
void handleRoot() {
  String html = "<html><head>";
  html += "<meta charset='UTF-8'>";
  html += "<meta http-equiv='refresh' content='2'>";
  html += "<style>";
  html += "body { font-family: Arial, sans-serif; }";
  html += ".no-data { color: red; font-weight: bold; }";
  html += "ul { list-style: none; padding-left: 0; }";
  html += "li { margin-bottom: 8px; }";
  html += "</style>";
  html += "</head><body>";
  html += "<h1>ì‹¤ì‹œê°„ GPS ë° í™˜ê²½ ì •ë³´</h1>";
  html += lastLocation;
  html += "</body></html>";
  server.send(200, "text/html", html);
}

void setup() {
  Serial.begin(115200);
  gpsSerial.begin(9600);
  dht.begin();

  myServo.attach(SERVO_PIN);   // ì„œë³´ëª¨í„° í•€ ì—°ê²°
  myServo.write(0);            // ì„œë³´ ê¸°ë³¸ ìœ„ì¹˜

  WiFi.begin(ssid, password);
  Serial.print("WiFi ì—°ê²° ì¤‘");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi ì—°ê²°ë¨, IP: " + WiFi.localIP().toString());

  server.on("/", handleRoot);
  server.begin();
  Serial.println("ì›¹ì„œë²„ ì‹œì‘ë¨");
}

void loop() {
  while (gpsSerial.available()) {
    gps.encode(gpsSerial.read());
  }

  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  // ğŸŒ€ ìŠµë„ì— ë”°ë¼ ì„œë³´ëª¨í„° ì œì–´
  if (!isnan(humidity)) {
    if (humidity >= 50) {
      myServo.write(90);  // ìŠµë„ 50% ì´ìƒì´ë©´ ì„œë³´ 90ë„ íšŒì „
    } else {
      myServo.write(0);   // ì•„ë‹ˆë©´ 0ë„ ìœ„ì¹˜
    }
  } else {
    myServo.write(0);     // ì„¼ì„œ ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ìœ„ì¹˜
  }

  // ê°’ í‘œì‹œìš© ë¬¸ìì—´ êµ¬ì„±
  String latStr = gps.location.isValid() ? String(gps.location.lat(), 6) : "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>";
  String lngStr = gps.location.isValid() ? String(gps.location.lng(), 6) : "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>";
  String altStr = gps.altitude.isValid() ? String(gps.altitude.meters()) + " m" : "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>";
  String speedStr = gps.speed.isValid() ? String(gps.speed.kmph()) + " km/h" : "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>";
  String courseStr = gps.course.isValid() ? String(gps.course.deg()) + "Â°" : "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>";
  String satStr = (gps.satellites.value() > 0) ? String(gps.satellites.value()) : "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>";

  String timeStr;
  if (gps.time.isValid()) {
    timeStr = String(gps.time.hour()) + ":" +
              (gps.time.minute() < 10 ? "0" : "") + String(gps.time.minute()) + ":" +
              (gps.time.second() < 10 ? "0" : "") + String(gps.time.second());
  } else {
    timeStr = "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>";
  }

  String tempStr = isnan(temperature) ? "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>" : String(temperature, 1) + " Â°C";
  String humStr = isnan(humidity) ? "<span class='no-data'>ì •ë³´ ì—†ìŒ</span>" : String(humidity, 1) + " %";

  // HTMLì— í‘œì‹œí•  ë°ì´í„° ì •ë¦¬
  lastLocation = "<ul>";
  lastLocation += "<li>ğŸ“ ìœ„ë„: " + latStr + "</li>";
  lastLocation += "<li>ğŸ“ ê²½ë„: " + lngStr + "</li>";
  lastLocation += "<li>â›°ï¸ ê³ ë„: " + altStr + "</li>";
  lastLocation += "<li>ğŸš€ ì†ë„: " + speedStr + "</li>";
  lastLocation += "<li>ğŸ§­ ì´ë™ ë°©í–¥: " + courseStr + "</li>";
  lastLocation += "<li>ğŸ“¡ ìœ„ì„± ìˆ˜: " + satStr + "</li>";
  lastLocation += "<li>â° ì‹œê°„ (UTC): " + timeStr + "</li>";
  lastLocation += "<li>ğŸŒ¡ï¸ ì˜¨ë„: " + tempStr + "</li>";
  lastLocation += "<li>ğŸ’§ ìŠµë„: " + humStr + "</li>";
  lastLocation += "</ul>";

  server.handleClient();
  delay(1000);
  }
